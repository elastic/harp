// Licensed to Elasticsearch B.V. under one or more contributor
// license agreements. See the NOTICE file distributed with
// this work for additional information regarding copyright
// ownership. Elasticsearch B.V. licenses this file to you under
// the Apache License, Version 2.0 (the "License"); you may
// not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.

package release

import (
	"bytes"
	"crypto/sha256"
	"fmt"
	"io"
	"os"
	"strings"
	"text/template"

	"github.com/elastic/harp/build/artifact"
)

var formulaTemplate = `# typed: false
# frozen_string_literal: true

# Code generated by Harp build tool
class {{ .Formula }} < Formula
  desc "{{ .Description }}"
  homepage "https://{{ .Repository }}"
  version "{{ .Version }}"
  license "Apache-2.0"

  on_macos do
    if Hardware::CPU.intel?
      url "https://{{ .Repository }}/releases/download/{{ .Release }}/{{ .Bin }}-darwin-amd64-v1.tar.gz"
      sha256 "{{ sha256file (printf "dist/%s-darwin-amd64-v1.tar.gz" .Bin) }}"
    elsif Hardware::CPU.arm?
      url "https://{{ .Repository }}/releases/download/{{ .Release }}/{{ .Bin }}-darwin-arm64-v8.0.tar.gz"
      sha256 "{{ sha256file (printf "dist/%s-darwin-arm64-v8.0.tar.gz" .Bin) }}"
    end
  end

  on_linux do
    if Hardware::CPU.intel?
      if Hardware::CPU.is_64_bit?
        url "https://{{ .Repository }}/releases/download/{{ .Release }}/{{ .Bin }}-linux-amd64-v1.tar.gz"
        sha256 "{{ sha256file (printf "dist/%s-linux-amd64-v1.tar.gz" .Bin) }}"
      end
    elsif Hardware::CPU.arm?
      if Hardware::CPU.is_64_bit?
        url "https://{{ .Repository }}/releases/download/{{ .Release }}/{{ .Bin }}-linux-arm64-v8.0.tar.gz"
        sha256 "{{ sha256file (printf "dist/%s-linux-arm64-v8.0.tar.gz" .Bin) }}"
      else
        url "https://{{ .Repository }}/releases/download/{{ .Release }}/{{ .Bin }}-linux-arm-6.tar.gz"
        sha256 "{{ sha256file (printf "dist/%s-linux-arm-6.tar.gz" .Bin) }}"
      end
    end
  end

  conflicts_with "{{ .Bin }}-fips", because: "{{ .Bin }}-fips also ships a '{{ .Bin }}' binary"

  def install
    ENV.deparallelize

    # Install binaries
    if OS.mac?
      if Hardware::CPU.arm?
        bin.install "{{ .Bin }}-darwin-arm64-v8.0" => "{{ .Bin }}"
      else
        bin.install "{{ .Bin }}-darwin-amd64-v1" => "{{ .Bin }}"
      end
    elsif OS.linux?
      if Hardware::CPU.arm?
        if Hardware::CPU.is_64_bit?
          bin.install "{{ .Bin }}-linux-arm64-v8.0" => "{{ .Bin }}"
        else
          bin.install "{{ .Bin }}-linux-arm-6" => "{{ .Bin }}"
        end
      elsif Hardware::CPU.is_64_bit?
        bin.install "{{ .Bin }}-linux-amd64-v1" => "{{ .Bin }}"
      end
    end

    # Exclude from Gatekeeper quarantine on macOS Catalina+
    quarantine_check = Utils.safe_popen_read("xattr", bin/"{{ .Bin }}")
    if OS.mac? && MacOS.version >= :catalina && /com.apple.quarantine/.match?(quarantine_check)
      (bin/"{{ .Bin }}").chmod 0755
      begin
        system "xattr", "-d",
                        "com.apple.quarantine",
                        bin/"{{ .Bin }}"
      ensure
        (bin/"{{ .Bin }}").chmod 0555
      end
    end

    # Final message
    ohai "Install success!"
  end

  def caveats
    <<~EOS
      If you have previously built {{ .Bin }} from source, make sure you're not using
      $GOPATH/bin/{{ .Bin }} instead of this one. If that's the case you can simply run
      rm -f $GOPATH/bin/{{ .Bin }}
    EOS
  end

  test do
    assert_path_exists bin/"{{ .Bin }}"
    assert_match version.to_s, shell_output("#{bin}/{{ .Bin }} version")
  end
end
`

type formulaModel struct {
	Repository  string
	Bin         string
	Formula     string
	Description string
	Release     string
	Version     string
}

// HomebrewFormula generates HomeBrew formula for given command.
func HomebrewFormula(cmd *artifact.Command) func() error {
	sha256sum := func(filename string) (string, error) {
		// Open file
		//nolint:gosec // G304: filename is from build artifacts, not user input
		f, err := os.Open(filename)
		if err != nil {
			return "", err
		}
		defer f.Close()

		// Prepare hasher
		h := sha256.New()
		if _, err := io.Copy(h, f); err != nil {
			return "", err
		}

		// No error
		return fmt.Sprintf("%x", h.Sum(nil)), nil
	}
	return func() error {
		// Compile template
		formulaTpl, err := template.New("Formula").Funcs(map[string]any{
			"sha256file": sha256sum,
		}).Parse(formulaTemplate)
		if err != nil {
			return err
		}

		// Merge data
		var buf bytes.Buffer
		release := os.Getenv("RELEASE")
		version := strings.TrimPrefix(release, "v")
		if errTmpl := formulaTpl.Execute(&buf, &formulaModel{
			Repository:  cmd.Package,
			Bin:         cmd.Kebab(),
			Formula:     cmd.Camel(),
			Description: cmd.Description,
			Release:     release,
			Version:     version,
		}); errTmpl != nil {
			return errTmpl
		}

		// Write output to Stdout
		_, errWrite := buf.WriteTo(os.Stdout)
		return errWrite
	}
}
